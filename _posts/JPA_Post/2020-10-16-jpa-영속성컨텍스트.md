---
title   : "영속성 컨텍스트"
categories : 
    - jpa
tags : 
    - java
    - spring
    - jpa
sidebar:
    title: "JPA"
    nav : sidebar-posts
---  

### 영속성 컨텍스트

JPA를 이해는데 가장 중요한 용어는 **영속성 컨텍스트(persistence context)**이다.  

한글로 번역해보자면 **"엔티티를 영구 저장하는 환경"** 이라는 뜻이다.  

엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텐스트에 엔티티를 보관하고 관리한다.  

`em.persist(member)`  

위 코드를 우리는 단순하게 member 엔티티를 데이터베이스에 저장한다고 표현했다.  

정확히 표현하자면 persist() 메소드는 **엔티티 매니저를 사용해서 member 엔티티를 영속성 컨텍스트에 저장**한다는 것이다.  

영속성 컨텍스트는 논리적인 개념에 가까워 눈에 보이지 않는다.  

영속성 컨텍스트는 엔티티 매니저를 생성할 때 하나 만들어진다. 엔티티 매니저를 통해 영속성 컨텍스트에 접근할 수 있고, 관리할 수 있다.  


### 엔티티의 생명주기  

엔티티에는 4가지의 상태가 존재한다.  

- **비영속(new/trasient):** 영속성 컨텍스트와 전혀 관계가 없는 상태
- **영속(managed):** 영속성 컨텍스트에 저장된 상태
- **준영속(detached):** 영속성 컨텍스트에 저장되었다가 분리된 상태
- **삭제(removed):** 삭제된 상태  

#### 비영속  

순수한 객체 상태이며 아직 영속성 컨텍스트에 보관되지 않고 있다.  

따라서 데이터베이스나 영속성 컨텍스트와는 전혀 관련이 없다.

```java
// 객체를 생성한 상태(비영속)
Member member = new Member();
member.setId(1L);
member.setName("yoon");
```  

#### 영속  

```java
em.persist(member);
```

엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장했다.  

**영속성 컨텍스트가 관리하는 엔티티를 영속 상태라 한다.**  

회원 엔티티는 비영속 상태에서 영속 상태가 되었다.  

**영속 상태라는 것은 영속성 컨텍스트에 의해 관리된다는 뜻이다.**  

> em.find()나 JPQL을 사용해서 조회한 엔티티도 영속성 컨텍스트가 관리하는 영속 상태이다.

#### 준영속  

영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다.  

특정 엔티티를 준영속 상태로 만들려면 `em.detach()`를 호출하면 된다.  

```java
em.detach(member);
```

`em.close()`를 호출해서 닫거나 `em.clear`를 호출해서 영속성 컨텍스트를 초기화해도 영속성 컨텍스트가 관리하던 영속 상태의 엔티티는 준영속 상태가 된다.  

#### 삭제

```java
em.remove(member);
```  

엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.  

---

#### 출처  
- **자바 ORM 표준 JPA 프로그래밍 김영한 저**  
- **인프런: 자바 ORM 표준 JPA 프로그래밍 - 기본편**  